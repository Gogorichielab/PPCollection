  <div class="action-bar">
    <div class="title-group">
      <h2>Inventory</h2>
      <small><%= pagination.totalCount %> item<%= pagination.totalCount === 1 ? '' : 's' %> on record</small>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <a class="btn btn-secondary" href="/firearms/export" download="firearms.csv">Export CSV</a>
      <a class="btn" href="/firearms/new">+ Add Firearm</a>
    </div>
  </div>

  <% if (items.length > 0) { %>
    <% const statusOptions = [...new Set(items.map((i) => i.status).filter(Boolean))]; %>
    <% const conditionOptions = [...new Set(items.map((i) => i.condition).filter(Boolean))]; %>
    <% const firearmTypeOptions = [...new Set(items.map((i) => i.firearm_type).filter(Boolean))]; %>

    <div class="filters-panel">
      <div class="search-container">
        <div class="search-controls">
          <input type="text" id="search-input" placeholder="Search firearms..." class="search-input" aria-label="Search firearms">
          <select id="search-field" class="search-select" aria-label="Choose a field to search">
            <option value="all">All Fields</option>
            <option value="make">Make</option>
            <option value="model">Model</option>
            <option value="caliber">Caliber</option>
            <option value="serial">Serial</option>
            <option value="purchase_date">Purchase Date</option>
            <option value="status">Status</option>
            <option value="condition">Condition</option>
            <option value="firearm_type">Firearm Type</option>
          </select>
        </div>
        <div class="filter-actions">
          <span class="filter-badge neutral" id="all-items-badge" aria-label="All items">
            All items <span class="badge-count"><%= items.length %></span>
          </span>
          <button type="button" class="btn btn-secondary" id="search-reset">Clear all</button>
        </div>
      </div>

      <div class="filter-groups" aria-label="Filters">
        <% if (statusOptions.length) { %>
          <div class="filter-group" data-facet-group="status">
            <div class="filter-label">Status</div>
            <div class="filter-options">
              <% statusOptions.forEach((status) => { %>
                <label class="filter-chip">
                  <input type="checkbox" class="facet-input" value="<%= status %>" data-facet="status">
                  <span><%= status %></span>
                </label>
              <% }) %>
            </div>
          </div>
        <% } %>

        <% if (conditionOptions.length) { %>
          <div class="filter-group" data-facet-group="condition">
            <div class="filter-label">Condition</div>
            <div class="filter-options">
              <% conditionOptions.forEach((condition) => { %>
                <label class="filter-chip">
                  <input type="checkbox" class="facet-input" value="<%= condition %>" data-facet="condition">
                  <span><%= condition %></span>
                </label>
              <% }) %>
            </div>
          </div>
        <% } %>

        <% if (firearmTypeOptions.length) { %>
          <div class="filter-group" data-facet-group="firearm_type">
            <div class="filter-label">Firearm Type</div>
            <div class="filter-options">
              <% firearmTypeOptions.forEach((firearmType) => { %>
                <label class="filter-chip">
                  <input type="checkbox" class="facet-input" value="<%= firearmType %>" data-facet="firearm_type">
                  <span><%= firearmType %></span>
                </label>
              <% }) %>
            </div>
          </div>
        <% } %>
      </div>

      <div class="active-filters" id="active-filters" aria-label="Active filters">
        <span class="muted-text" data-empty-message>No filters applied.</span>
      </div>
    </div>
  <% } %>

  <% if (!items.length) { %>
    <p>No firearms yet. Click "Add Firearm" to create one.</p>
  <% } else { %>
    <div class="table-wrapper">
      <div id="results-status" class="visually-hidden" role="status" aria-live="polite"></div>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">
              <button class="table-sort" type="button" data-sort-key="make" aria-sort="none">
                <span>Make</span>
                <span class="sort-icon" aria-hidden="true">⇅</span>
              </button>
            </th>
            <th scope="col">
              <button class="table-sort" type="button" data-sort-key="model" aria-sort="none">
                <span>Model</span>
                <span class="sort-icon" aria-hidden="true">⇅</span>
              </button>
            </th>
            <th scope="col">
              <button class="table-sort" type="button" data-sort-key="caliber" aria-sort="none">
                <span>Caliber</span>
                <span class="sort-icon" aria-hidden="true">⇅</span>
              </button>
            </th>
            <th scope="col">
              <button class="table-sort" type="button" data-sort-key="serial" aria-sort="none">
                <span>Serial</span>
                <span class="sort-icon" aria-hidden="true">⇅</span>
              </button>
            </th>
            <th scope="col">
              <button class="table-sort" type="button" data-sort-key="purchase_date" aria-sort="none">
                <span>Purchase Date</span>
                <span class="sort-icon" aria-hidden="true">⇅</span>
              </button>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="firearms-tbody">
        <% items.forEach(i => { %>
          <tr
            data-make="<%= i.make %>"
            data-model="<%= i.model %>"
            data-caliber="<%= i.caliber || '' %>"
            data-serial="<%= i.serial || '' %>"
            data-status="<%= i.status || '' %>"
            data-condition="<%= i.condition || '' %>"
            data-firearm_type="<%= i.firearm_type || '' %>"
            data-purchase_date="<%= i.purchase_date || '' %>"
          >
            <td><%= i.make %></td>
            <td><%= i.model %></td>
            <td><%= i.caliber || '' %></td>
            <td><%= i.serial || '' %></td>
            <td><%= i.purchase_date || '' %></td>
            <td class="text-right"><a class="btn btn-secondary" href="/firearms/<%= i.id %>">View</a></td>
          </tr>
        <% }) %>
        </tbody>
      </table>
      <div id="no-results" class="no-results" role="alert" aria-live="polite" hidden>
        <p>No matches found. Adjust your filters or clear them to see all firearms.</p>
      </div>
    </div>

    <% if (pagination.totalPages > 1) { %>
      <div class="pagination">
        <div class="pagination-info">
          Showing <%= (pagination.currentPage - 1) * pagination.perPage + 1 %> to <%= Math.min(pagination.currentPage * pagination.perPage, pagination.totalCount) %> of <%= pagination.totalCount %>
        </div>
        <div class="pagination-controls">
          <% if (pagination.hasPrevious) { %>
            <a href="?page=<%= pagination.currentPage - 1 %>" class="btn btn-secondary pagination-btn">← Previous</a>
          <% } else { %>
            <button class="btn btn-secondary pagination-btn" disabled>← Previous</button>
          <% } %>
          
          <span class="pagination-current">
            Page <%= pagination.currentPage %> of <%= pagination.totalPages %>
          </span>
          
          <% if (pagination.hasNext) { %>
            <a href="?page=<%= pagination.currentPage + 1 %>" class="btn btn-secondary pagination-btn">Next →</a>
          <% } else { %>
            <button class="btn btn-secondary pagination-btn" disabled>Next →</button>
          <% } %>
        </div>
      </div>
    <% } %>
  <% } %>

  <script src="/static/js/search.js"></script>
